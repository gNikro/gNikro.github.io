<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>jsVideoAndChat-</title>
	<meta name="description" content="" />
	
	<script src="/dist/mobile-detect.min.js"></script>
	
	<link rel="stylesheet" href="mainStyle.min.css" type="text/css">
		
</head>
<body>
	
	<div>
		<div style="pointer-events: none;" id="presentationPlayer"></div>
		<div style="pointer-events: none;" id="speackerPlayer"></div>
		
		<div id="palyButton" style="position:absolute; top:50%; left:220px;">
			<img src="/img/playbutton.png"/>
		</div>
	</div>

	
	<script>
		
		var md = new MobileDetect(window.navigator.userAgent);
		
		var isMobile = false;
		if(md.mobile())
			isMobile = true;
			
		if(!isMobile)
		{
			document.getElementById("presentationPlayer").style = "pointer-events: none; opacity: 0.4;"
			document.getElementById("speackerPlayer").style = "pointer-events: none; opacity: 0.4;"
			document.getElementById("palyButton").onclick = onPlayClick;
		}
		
		function onPlayClick()
		{
			initialize();
			
			document.getElementById("presentationPlayer").style = "pointer-events: none;"
			document.getElementById("speackerPlayer").style = "pointer-events: none;"
			document.getElementById("palyButton").hidden = true;
		}
			
		function AdjustIframeHeightOnLoad()
		{ 
			//document.getElementById("showDiv").style.height = document.getElementById("showDiv").contentWindow.document.body.scrollHeight + "px"; 
		}
		
		function AdjustIframeHeight(i) 
		{
			document.getElementById("showDiv").style.height = parseInt(i) + "px"; 
		}
		
		window.onbeforeunload = function (event) 
		{
			var message = 'Вы уверены, что хотите покинуть страницу трансляции? После этого Вы не сможете зайти в неё повторно!';
			
			if (typeof event == 'undefined') 
			{
				event = window.event;
			}
			
			if (event) 
			{
				event.returnValue = message;
			}
			
			return message;
		}
		
		var startTime;
		
		function initVideo(_startTime)
		{
			
			var tag = document.createElement('script');
			tag.src = "https://www.youtube.com/player_api";
			var firstScriptTag = document.getElementsByTagName('script')[0];
			firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
			
			startTime = _startTime;
		}
	
		var presentationPlayer;
		var speackerPlayer;
		var startAppCallback;
		
		function onYouTubePlayerAPIReady() 
		{
			speackerPlayer = new YT.Player
			(
				'speackerPlayer', 
				{
					height: '390',
					width: '640',
					
					playerVars: {
						color: 'white',
						controls: '2',
						autohide:'0',
						disablekb:'1',
						showinfo:'0'
					}
				}
			);
			
			presentationPlayer = new YT.Player
			(
				'presentationPlayer', 
				{
					height: '390',
					width: '640',
					
					playerVars: {
						color: 'white',
						controls: '2',
						autohide:'0',
						disablekb:'1',
						showinfo:'0',
					},
					
					events: {
						onStateChange: onPlayerStateChange,
						onReady: initialize
					}
				}
			);
		}

		function onPlayerStateChange(event)
		{
			if(event.data == YT.PlayerState.PLAYING)
			{
				var duration = presentationPlayer.getDuration() - presentationPlayer.getCurrentTime();
				setTimeout(onVideoEnded, duration * 1000 - 1000);
				setTimeout(onShowDiv, 1000);
				
				startAppCallback();
			}
		}
		
		function onShowDiv()
		{
			document.getElementById("showDiv").hidden = false;
		}
		
		function onVideoEnded()
		{
			if(presentationPlayer)
				presentationPlayer.destroy();
			
			if(speackerPlayer)
				speackerPlayer.destroy();
			
			window.onbeforeunload = null;
			//window.location = "http://google.com";
		}
		
		function addStartCallback(value)
		{
			startAppCallback = value;
		}
		
		function initialize()
		{
			presentationPlayer.loadVideoById({
									'videoId': 'XzE032-pGp8',
									'startSeconds': startTime,
									//'endSeconds': 60,
									'suggestedQuality': 'large'});
									
			presentationPlayer.setVolume(0);
			
			speackerPlayer.loadVideoById({
									'videoId': '256UbEOEKCs',
									'startSeconds': startTime,
									//'endSeconds': 60,
									'suggestedQuality': 'large'});
									
			speackerPlayer.setVolume(0);
		}
		
		
		//function resizeIframe(obj) 
		//{
		//	obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
		//}
	
	</script>
	
	<div id="waitingScreen" hidden>
		<div id="waitingTimer">.....</div>
	</div>
	
	<div id="eventEnd" hidden>
		Мероприятие закончилось
	</div>
	
	<div id="container" hidden>
		<div id="usersBlock">
			<div id="usersHeader">Всего участников: {0}</div>
			<div id="users"></div>
		</div>
		
		<div id="chatBlock">
			Чат:
			<div id="chat"></div>
			<input id="chatInput"></input>
			<button id="sendButton">Отправить</button>
		</div>
	</div>

	<div>
		<iframe id="showDiv" src="http://murigin.ru/150za6/button_order.html" frameborder="0" scrolling="no" style="margin:0; width:100%; height:150px; border:none; overflow:hidden;" onload="AdjustIframeHeightOnLoad()" hidden></iframe>
	</div>
	
	<script src="core.js"></script>
	<!-- <script src="https://www.youtube.com/player_api"></script> -->
</body>
</html>